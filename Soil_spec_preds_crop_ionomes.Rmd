---
title: Soil spectral predictions of cereal grain ionome archetypes from Malawi
author: M.G. Walsh, A.M. Sila, D.B. Kumssa, A.R. Mossa, T. Amede, P.C. Nalivata, D. Gashu, S.M. Haefele, S. Gameda, M.R. Broadley, E.J.M. Joy, E.H. Bailey, R.M. Lark, B.A. Walsh, R. Rodr√≠guez Iglesias, J. Chamberlin and S. Snapp
date: "`r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    keep_md: true
    number_sections: true
    css: style1.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

Micronutrients i.e., the essential vitamins and minerals, are important for child development as well as for the prevention of morbidity and disease in adults. Except for vitamin D, micronutrients are not produced in the body and must be obtained from the diet. Although people only need small amounts of micronutrients, consuming the recommended amounts is important as micronutrient deficiencies (MNDs) can have serious consequences on both health and well-being. "*Effective MND surveillance is essential to inform policy responses to current food system challenges and socioeconomic and environmental drivers of change. Potential food system interventions to alleviate MNDs, such as food fortification and biofortification through breeding crops with increased micronutrient concentrations in their edible portions, should consider subnational geographical effects, which can be larger in magnitude than planned intervention outcomes*" ([Gashu et al., 2020](https://www.nature.com/articles/s41586-021-03559-3)).

However, national surveys containing staple crop micronutrient data are not routinely collected in most developing countries because they are expensive, time-consuming, and limited to the annual harvest season(s), both in the field and the laboratory. Also, the databases that are needed to analyze dietary micronutrient supplies against demands should be georeferenced to be effective, but coordinates and time stamps are often either only roughly linked to sampled administrative or project regions or are completely absent in Africa. Similarly, agronomic interventions that focus on plant micronutrients for improving cropland and livestock productivity are inadequately supported by spatial and temporal data because the distributions of different staple crops and livestock are usually not known and are not regularly monitored at national scales.

Spectral signatures of soils, plants, animal tissues, and materials generally are defined by their reflectance or absorbance as a function of wavelength in the electromagnetic spectrum. Under laboratory conditions, the signatures result from electronic transitions of atoms and vibrational stretching and bending of structural groups of atoms that form molecules or crystals. Spectroscopy has been shown to provide highly repeatable, rapid, and low-cost measurements of different soil, plant, and animal tissue properties in numerous studies. The amount of light absorbed by a solid sample can be measured with minimal sample preparation (primarily drying and grinding) across a wide range of ultra-violet (UV), visible (VIS), near (NIR), and mid-infrared (MIR) wavelengths to provide a unique spectral signature of soil, plant or animal samples. An individual measurement can be performed in about 20 seconds, in contrast to more conventional soil and plant tests, which are typically slow, labor-intensive, expensive, and/or use hazardous chemicals, which have to be handled carefully by laboratories.

This notebook examines spectral predictions associated with mineral nutrient deficiency risks for humans using cereal grain data from Malawi. It is intended to be a companion to a spatial prediction workflow, which can be downloaded [here](). The data we will be using were generated by the [GeoNutrition Project](http://www.geonutrition.com). Nationally representative cropland sampling frames and the laboratory methods that were used in the data collections are well described in [Gashu et al., (2021)](https://doi.org/10.1038/s41586-021-03559-3). An overall data descriptor article provides additional information and some of the raw data downloads at: [Kumssa et al., (2022) ](https://www.nature.com/articles/s41597-022-01500-5). The notebook itself is maintained on GitHub ([here](https://github.com/mgwalsh/GeoNutrition/blob/main/Soil_spec_preds_crop_ionomes.Rmd)). Feel free to alter and use it as you see fit, but also please cite it when you do so. It is copyrighted as [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/).

# Data setup

To actually run this notebook, you will need to load the packages indicated in the chunk below.

```{r, results = 'hide'}
# Package names
packages <- c("tidyverse", "rgdal", "leaflet", "htmlwidgets", "DT", "compositions", "archetypes",
              "doParallel", "caret", "caretEnsemble", "quantreg")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The primary ionomic labels used in this notebook include *Inductively Coupled Plasma Mass Spectrometry* ([ICP-MS](https://en.wikipedia.org/wiki/Inductively_coupled_plasma_mass_spectrometry)) nutrient concentration measurements of cereal grain samples (in mg kg^-1^), including: Na, Mg, P, S, K, Ca, Cr, Mn, Fe, Co, Cu, Zn, Se, Mo, and I. They also include the georeference of where the samples were collected (lon/lat, EPSG:3857), the cereal crop that was sampled at that location, and the provenance of the grain samples (i.e., from the standing crop, a field stack or a closely located grain store). Note that any crop nutrient measurements below their respective limits of detection have been set to 2/3 of the respective minimum observed values. You can download the file from our OSF repository using the following link: [`MWI_grain_CoDa.csv`](https://osf.io/zj5b7).

The associated soil samples were air-dried and then finely ground to powder (<100 microns) using an agate sample mill. The samples were then loaded into aluminum microtiter plates (A752-96, Bruker Optics, Karlsruhe) using a micro spatula to fill the 6-mm diameter wells and leveled. Samples were loaded into four replicate wells, each scanned 32 times in MIR reflectance mode using a Bruker Tensor 27 MIR spectrometer with a high throughput screening arm and a liquid nitrogen cooled HgCdTe detector. The spectra obtained for each sample were then transferred to a desktop computer where they were averaged and combined into a single flat dataframe. You can download the spectral feature file from our OSF repository via this link [`MWI_soil_mir_spectra.csv`](https://osf.io/w5ng6). Ensure that you place both those files into your designated working directory.

The next chunk [closes](https://econ-papers.upf.edu/papers/1554.pdf) the CoDa and calculates *centered log ratios* ([clr](https://www.rdocumentation.org/packages/compositions/versions/2.0-1/topics/clr)). These can be analyzed, summarized, and interpreted with conventional univariate, multivariate, data and machine learning modeling methods ([Greenacre, 2021](https://www.annualreviews.org/doi/pdf/10.1146/annurev-statistics-042720-124436)). Note that you could also use other log ratios such as the [alr](https://www.rdocumentation.org/packages/compositions/versions/2.0-1/topics/alr), or the [ilr](https://www.rdocumentation.org/packages/compositions/versions/2.0-1/topics/ilr), but we shall leave those possibilities for you to explore.

```{r}
# Read the ICP-MS crop data
cpdat <- read.table("MWI_grain_CoDa.csv", header=T, sep=",")

# Calculate the CLRs
varc <- c("Na", "Mg", "P", "S", "K", "Ca", "Cr", "Mn", "Fe", "Co", "Cu", "Zn", "Se", "Mo", "I")
comps <- cpdat[varc]
comps <- comps / rowSums(comps) ## close the composition
comps <- as.data.frame(clr(comps)) ## centered log ratio (clr) transforms

# Attach site data info
locv <- c("csid", "ssid", "lat", "lon", "crop") 
locs <- cpdat[locv]
codat <- cbind(locs, comps)
```

# Compositional archetypes and unsupervised CoDa classification

*Archetypal analysis* ([Cutler and Breiman, 1994](https://www.stat.cmu.edu/technometrics/90-00/vol-36-04/v3604338.pdf)) is an unsupervised learning method similar to e.g., [K-means clustering](https://towardsdatascience.com/k-means-clustering-explained-4528df86a120). It describes each observation in a dataset as a mixture of archetypes. Rather than describing average or typical observations and measurements, archetypal analysis seeks to identify extreme points on the [convex hull](https://en.wikipedia.org/wiki/Convex_hull) of a data matrix, which can provide a simple and quite useful way of clustering and looking at multivariate data ([Eugster and Leisch, 2009](https://cran.r-project.org/web//packages/archetypes/vignettes/archetypes.pdf)). The identified archetypes themselves are mixtures of the individual CoDA variables under consideration. Archetypal mixture coefficients and projections are also CoDa, which is why we include them in this notebook. Note that other clustering and ordination algorithms could also be used in this context ([Greenacre, 2021](https://www.annualreviews.org/doi/pdf/10.1146/annurev-statistics-042720-124436)).

## Identifying archetypes

This next chunk fits the Malawi CLR data using the [`archetypes`](https://cran.r-project.org/web//packages/archetypes/vignettes/archetypes.pdf) package, which is a robust implementation of the original Cutler and Breiman (1994) algorithm that uses [k-fold validation](https://www.statology.org/k-fold-cross-validation/).

```{r, output = 'hide'}
# Fit nutrient archetypes with 10-fold cross validation
set.seed(85321)
comp.arc <- stepArchetypes(data=codat[,6:20], k = 1:10, nrep = 10, verbose = FALSE)
```

```{r, echo = FALSE, fig.align = "center", fig.height = 4, fig.width = 4, fig.cap = "**Fig. 1**: Archetype scree-plot showing the number of archetypes versus the multivariate residual sums of squares (RSS)."}

par(pty="s", mar=c(4,4,1,1))
screeplot(comp.arc)
```

## Archetypal classification

Similar to other clustering and ordination algorithms, we can use the identified archetypes for dimensional reduction and unsupervised classification.

```{r}
# Select no. of archetypes, the scree plot in Fig. 1 above suggests 3-7 ... we use 4 here
comp.arc4 <- bestModel(comp.arc[[4]])

# Classify CLRs by "dominant archetypes" (DA)
darc <- as.data.frame(predict(comp.arc4, codat[,6:20]))
darc$DA <- apply(darc, 1, which.max)
colnames(darc) <- c("A1","A2","A3","A4","DA")
cpdat <- cbind(cpdat, darc)
codat <- cbind(codat, darc)

# Write out the cpdat file for reuse
dir.create("MW_coda", showWarnings=F)
write.csv(cpdat, "./MW_coda/MW_coda_archetypes.csv", row.names = F)
```

```{r, echo = FALSE, fig.align = "center", fig.show = 'hold', fig.height = 10.5, fig.cap = "**Fig. 2**: Boxplots of nutrient compositional differences between dominant archetypes."}

par(mfrow = c(5,3), pty="s", mar=c(2,4,1,1))
boxplot(codat$Na ~ codat$DA, notch = T, ylab = "Na", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Mg ~ codat$DA, notch = T, ylab = "Mg", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$P ~ codat$DA, notch = T, ylab = "P", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$S ~ codat$DA, notch = T, ylab = "S", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$K ~ codat$DA, notch = T, ylab = "K", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Ca ~ codat$DA, notch = T, ylab = "Ca", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Cr ~ codat$DA, notch = T, ylab = "Cr", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Mn ~ codat$DA, notch = T, ylab = "Mn", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Fe ~ codat$DA, notch = T, ylab = "Fe", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Co ~ codat$DA, notch = T, ylab = "Co", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Cu ~ codat$DA, notch = T, ylab = "Cu", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Zn ~ codat$DA, notch = T, ylab = "Zn", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Se ~ codat$DA, notch = T, ylab = "Se", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$Mo ~ codat$DA, notch = T, ylab = "Mo", xlab = "", cex.axis = 1, cex.lab = 1.3)
boxplot(codat$I ~ codat$DA, notch = T, ylab = "I", xlab = "", cex.axis = 1, cex.lab = 1.3)
```


 